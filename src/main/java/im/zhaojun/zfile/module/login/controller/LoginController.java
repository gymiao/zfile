package im.zhaojun.zfile.module.login.controller;import cn.hutool.core.util.ObjectUtil;import cn.hutool.crypto.SecureUtil;import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;import com.github.xiaoymin.knife4j.annotations.ApiSort;import dev.samstevens.totp.exceptions.QrGenerationException;import im.zhaojun.zfile.core.util.AjaxJson;import im.zhaojun.zfile.core.util.JwtTokenUtils;import im.zhaojun.zfile.module.config.model.dto.SystemConfigDTO;import im.zhaojun.zfile.module.config.service.SystemConfigService;import im.zhaojun.zfile.module.login.entity.User;import im.zhaojun.zfile.module.login.model.enums.LoginVerifyModeEnum;import im.zhaojun.zfile.module.login.model.request.VerifyLoginTwoFactorAuthenticatorRequest;import im.zhaojun.zfile.module.login.model.result.LoginTwoFactorAuthenticatorResult;import im.zhaojun.zfile.module.login.model.result.LoginVerifyImgResult;import im.zhaojun.zfile.module.login.request.UserLoginRequest;import im.zhaojun.zfile.module.login.service.AuthService;import im.zhaojun.zfile.module.login.service.IUserService;import im.zhaojun.zfile.module.login.service.ImgVerifyCodeService;import im.zhaojun.zfile.module.login.service.TwoFactorAuthenticatorVerifyService;import io.swagger.annotations.Api;import io.swagger.annotations.ApiOperation;import lombok.extern.slf4j.Slf4j;import org.springframework.security.core.Authentication;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.web.bind.annotation.*;import javax.annotation.Resource;import javax.security.auth.RefreshFailedException;import javax.validation.Valid;import java.util.Objects;/** * 登陆注销相关接口 * * @author zhaojun */@Api(tags = "登录模块")@ApiSort(1)@RestController@RequestMapping("/admin")@Slf4jpublic class LoginController {    @Resource    private SystemConfigService systemConfigService;    @Resource    private ImgVerifyCodeService imgVerifyCodeService;    @Resource    private TwoFactorAuthenticatorVerifyService twoFactorAuthenticatorVerifyService;    @Resource    private AuthService authService;    @ApiOperationSupport(order = 1, ignoreParameters = {"zfile-token"})    @ApiOperation(value = "登录")    @PostMapping("/login")    public AjaxJson<?> doLogin(@Valid @RequestBody UserLoginRequest userLoginRequest) {        System.out.println("登录");        SystemConfigDTO systemConfig = systemConfigService.getSystemConfig();        String verifyCode = userLoginRequest.getVerifyCode();        String verifyCodeUuid = userLoginRequest.getVerifyCodeUUID();        LoginVerifyModeEnum loginVerifyMode = systemConfig.getLoginVerifyMode();        String loginVerifySecret = systemConfig.getLoginVerifySecret();        if (Objects.equals(loginVerifyMode, LoginVerifyModeEnum.TWO_FACTOR_AUTHENTICATION_MODE)) {            twoFactorAuthenticatorVerifyService.checkCode(loginVerifySecret, verifyCode);        } else if (Objects.equals(loginVerifyMode, LoginVerifyModeEnum.IMG_VERIFY_MODE)) {            imgVerifyCodeService.checkCaptcha(verifyCodeUuid, verifyCode);        }        // 登录        String[] tokens = authService.createToken(userLoginRequest);        return AjaxJson.getSuccess("登录成功", tokens);    }    @ApiOperationSupport(order = 2)    @ApiOperation(value = "注销")    @PostMapping("/logout")    public AjaxJson<?> logout() {        authService.removeToken();        return AjaxJson.getSuccess("注销成功");    }    @ApiOperationSupport(order = 8)    @ApiOperation(value = "刷新Token")    @PostMapping("/refreshToken")    public AjaxJson<?> refreshToken(@RequestBody String refreshToken) throws RefreshFailedException {        System.out.println("刷新Token");        String token = authService.refreshToken(refreshToken);        System.out.println("新的token为: " + token);        return AjaxJson.getSuccess("登录成功", token);    }    @ApiOperationSupport(order = 3)    @ApiOperation(value = "生成 2FA")    @GetMapping("/2fa/setup")    public AjaxJson<LoginTwoFactorAuthenticatorResult> setupDevice() throws QrGenerationException {        LoginTwoFactorAuthenticatorResult loginTwoFactorAuthenticatorResult = twoFactorAuthenticatorVerifyService.setupDevice();        return AjaxJson.getSuccessData(loginTwoFactorAuthenticatorResult);    }    @ApiOperationSupport(order = 4)    @ApiOperation(value = "2FA 验证并绑定")    @PostMapping("/2fa/verify")    public AjaxJson<?> deviceVerify(@Valid @RequestBody VerifyLoginTwoFactorAuthenticatorRequest verifyLoginTwoFactorAuthenticatorRequest) {        twoFactorAuthenticatorVerifyService.deviceVerify(verifyLoginTwoFactorAuthenticatorRequest);        return AjaxJson.getSuccess();    }    @ApiOperationSupport(order = 5)    @ApiOperation(value = "获取登陆验证方式")    @GetMapping("/login/verify-mode")    public AjaxJson<LoginVerifyModeEnum> loginVerifyMode() {        SystemConfigDTO systemConfig = systemConfigService.getSystemConfig();        return AjaxJson.getSuccessData(systemConfig.getLoginVerifyMode());    }    @ApiOperationSupport(order = 6)    @ApiOperation(value = "获取图形验证码")    @GetMapping("/login/captcha")    public AjaxJson<LoginVerifyImgResult> captcha() {        LoginVerifyImgResult loginVerifyImgResult = imgVerifyCodeService.generatorCaptcha();        return AjaxJson.getSuccessData(loginVerifyImgResult);    }    @ApiOperationSupport(order = 7)    @ApiOperation(value = "检测是否已登录")    @GetMapping("/login/check")    public AjaxJson<Boolean> checkLogin() {        // 获取登录状态，假的        Boolean flag = authService.checkLogin();        return AjaxJson.getSuccessData(flag);    }}